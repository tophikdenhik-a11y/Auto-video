name: Auto Video

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "fact или story"
        required: true
        default: "fact"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg python3

    - name: Generate text
      run: |
        mkdir -p out

        if [ "${{ github.event.inputs.mode }}" = "fact" ]; then
          cat > out/text.txt << 'EOF'
Факт: У осьминога три сердца и голубая кровь.
Факт: Венера вращается в обратную сторону.
Факт: Мёд не портится тысячи лет.
Факт: В космосе невозможно заплакать из-за гравитации.
Факт: Мозг не чувствует боли.
 EOF
        else
          cat > out/text.txt << 'EOF'
История: Однажды мальчик нашёл старый фотоаппарат и увидел на снимках людей, которых не существовало.
История: В заброшенном доме часы шли только тогда, когда кто-то был рядом.
История: Рыбак поймал бутылку с письмом из будущего.
История: В деревне появился кот, который знал имена всех жителей.
 EOF
         fi

    shuf -n 1 out/text.txt > out/script.txt

    - name: Озвучка
      run: |
        npx edge-tts \
          --voice ru-RU-DmitryNeural \
          --text "$(cat out/script.txt)" \
          --write-media out/audio.mp3

    - name: Видео
      run: |
        ffmpeg -y -f lavfi -i color=c=black:s=1080x1920:d=6 \
        -i out/audio.mp3 \
        -vf "drawtext=text='$(cat out/script.txt)':fontcolor=white:fontsize=48:x=50:y=900" \
        -shortest out/video.mp4

    - name: Send to Telegram
      run: |
        FILE=$(ls out/*.mp4 | head -n 1)

        curl -F chat_id=${{ secrets.CHAT_ID }} \
             -F video=@$FILE \
             https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendVideo
